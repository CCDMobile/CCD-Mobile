<!DOCTYPE html>
<!--
================================================================================
CCD MOBILE INVENTORY MODULE v2.3.1 - OneDrive Sync Edition
================================================================================
A lightweight, mobile-optimized inventory management tool.
Real-time sync with OneDrive - works in Safari!

Features:
- PIN-protected access
- OneDrive API real-time sync (works in all browsers including Safari!)
- Search inventory by SKU, product name, or brand
- View and edit channel allocations (Etsy, Wix, Wayfair, TreasureMarts)
- Quick "Mark as Sold" with full sale details capture
- TreasureMart Inventory Audit with Found/Missing tracking
- Auto-sync every 30 seconds
- Change Master File location

Usage:
1. Open this file on your phone's browser
2. Enter PIN to access
3. Tap "Connect to OneDrive" and sign in with Microsoft
4. Make changes and tap Save - syncs automatically!

CHANGELOG v2.3.1 (2025-12-28):
- FIX: File browser now opens after authentication completes
- FIX: Better handling of "authenticated but no file selected" state
- FIX: Settings shows "Select Master JSON File" button when authenticated
- FIX: Token expiration now properly triggers re-authentication
- Improved error messages in file browser
- File browser shows loading state immediately

CHANGELOG v2.3.0 (2025-12-28):
- NEW: TreasureMart Inventory Audit workflow
  - Check off items as Found (green) or Missing (red highlighted)
  - Missing items auto-deduct from inventory when saved
  - Audit state persists between sessions
  - Reset button to clear all checkmarks
- NEW: Print/PDF export - opens printable page with checkbox column
- NEW: Excel export - downloads CSV file for spreadsheet use
- NEW: Missing Items Report - separate view of all missing items
  - Shows total count and lost value
  - Copy report to clipboard
- Items sorted by shelf number for easier physical inventory
- Save Changes button syncs missing item deductions to OneDrive

CHANGELOG v2.2.1 (2025-12-28):
- FIX: Authentication now tries popup first, falls back to redirect
- FIX: Token persisted to localStorage to survive Authenticator app switches
- FIX: Better session restoration after page reload
- RESTORED: TreasureMart Inventory Report (Settings > TreasureMart Report)
- Report shows all items allocated to TreasureMart with qty, price, totals
- Copy report to clipboard for easy sharing

CHANGELOG v2.2.0 (2025-12-28):
- RESTORED: Sale details modal with channel, quantity, price, date, and notes
- FIX: Sales now properly deduct from BOTH channel allocation AND warehouse qty
- FIX: Warehouse qty now shown correctly from master JSON (not sum of channels)
- FIX: Form fields scale properly on mobile (no longer cut off)
- Sale price auto-populates based on selected channel's calculated price
- Default channel selected based on which has inventory
- Confirmation message shows sale details (qty, channel, price)

CHANGELOG v2.1.0 (2025-12-27):
- MAJOR: Implemented correct channel-specific pricing formulas
- Now matches desktop system exactly for Etsy, Wix, Wayfair, TreasureMarts
- Prices calculated from wholesale + fees + overhead (not simple markup)
- Each channel shows its actual retail price (they can be different)
- Fixed alignment: quantities now line up in clean columns

CHANGELOG v2.0.6 (2025-12-27):
- Improved channel quantity alignment using CSS grid
- Quantities now align vertically for easier reading
- Prices align on the right for cleaner display
- Note: Retail prices shown are correct (base price + adjustments)

CHANGELOG v2.0.5 (2025-12-27):
- Updated branding: Replaced chicken emoji with Highland cow üêÆ
- Added Highland cow to splash screen (PIN entry)
- Added Highland cow to main header

CHANGELOG v2.0.4 (2025-12-27):
- Added retail price display next to each channel quantity
- Prices calculated from retailPrice + channelPriceAdjustments
- Product info fields (Name, SKU, Brand, Retail Price) are read-only by design
- Mobile app is for viewing and editing QUANTITIES only (not product details)

CHANGELOG v2.0.3 (2025-12-27):
- Fixed product info display in edit modal (uses retailPrice field directly)
- Fixed retail price display in inventory list
- Confirmed auto-sync functionality unchanged (30 seconds + immediate on save)

CHANGELOG v2.0.2 (2025-12-27):
- CRITICAL FIX: Changed field structure from channelAllocations to channels
- Fixed channel names to match Master JSON (lowercase: etsy, wix, wayfair, treasuremarts)
- Now correctly reads and displays inventory quantities from all channels
- Preserves existing channel data (like crazychicks) that isn't displayed in mobile app
- Compatible with desktop inventory system's JSON structure

================================================================================
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CCD Mobile Inventory</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg: #F3F4F6;
            --card-bg: #FFFFFF;
            --text: #1F2937;
            --text-light: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --onedrive: #0078D4;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-size: 16px;
        }

        /* PIN Screen */
        .pin-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .pin-screen.hidden {
            display: none;
        }

        .pin-logo {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .pin-title {
            color: white;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 30px;
        }

        .pin-input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
        }

        .pin-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.2s;
        }

        .pin-dot.filled {
            background: white;
            transform: scale(1.1);
        }

        .pin-dot.error {
            background: #EF4444;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 280px;
        }

        .pin-key {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 28px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pin-key:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }

        .pin-key.empty {
            visibility: hidden;
        }

        .pin-key.backspace {
            font-size: 24px;
        }

        .pin-error-msg {
            color: #FCA5A5;
            margin-top: 20px;
            font-size: 14px;
            height: 20px;
        }

        /* Main App */
        .app-container {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }

        .app-container.active {
            display: flex;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-btn:active {
            background: rgba(255,255,255,0.3);
        }

        .sync-status {
            font-size: 11px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 4px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10B981;
        }

        .sync-dot.syncing {
            background: #F59E0B;
            animation: pulse 1s infinite;
        }

        .sync-dot.error {
            background: #EF4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Search Bar */
        .search-bar {
            padding: 15px 20px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            border-color: var(--primary);
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px 20px;
            background: var(--card-bg);
        }

        .stat-card {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            padding: 15px;
            border-radius: 12px;
            color: white;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        /* Inventory List */
        .inventory-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
        }

        .inventory-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .inventory-item:active {
            transform: scale(0.98);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .item-title {
            flex: 1;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .item-sku {
            color: var(--text-light);
            font-size: 13px;
        }

        .item-qty {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-left: 10px;
        }

        .item-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            font-size: 13px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
        }

        .detail-label {
            color: var(--text-light);
        }

        .detail-value {
            font-weight: 500;
        }

        .item-channels {
            margin-top: 10px;
            padding: 8px;
            background: var(--bg);
            border-radius: 8px;
            font-size: 12px;
        }

        .channel-row {
            display: grid;
            grid-template-columns: 100px 40px 1fr;
            align-items: center;
            padding: 4px 0;
            gap: 8px;
        }

        .channel-label {
            color: var(--text-light);
            text-align: left;
        }

        .channel-qty {
            font-weight: 600;
            text-align: right;
            padding-right: 4px;
        }

        .channel-price {
            color: var(--success);
            font-weight: 500;
            font-size: 13px;
            text-align: right;
        }


        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 10px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-light);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            min-width: 0;
        }

        .form-input:focus {
            border-color: var(--primary);
        }

        .form-input:disabled {
            background: var(--bg);
            color: var(--text-light);
        }

        .channel-inputs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        @media (max-width: 380px) {
            .channel-inputs {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        .channel-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .channel-input-label {
            font-size: 12px;
            color: var(--text-light);
            font-weight: 500;
        }

        .channel-input {
            padding: 8px 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            text-align: center;
            width: 100%;
            min-width: 0;
        }

        .channel-input:focus {
            border-color: var(--primary);
        }

        .total-qty-display {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
            color: var(--text-light);
        }

        .total-qty-number {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text);
        }

        .btn-full {
            grid-column: 1 / -1;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text);
            color: white;
            padding: 14px 24px;
            border-radius: 10px;
            font-weight: 500;
            z-index: 300;
            opacity: 0;
            transition: all 0.3s;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.warning {
            background: var(--warning);
        }

        /* OneDrive Connection */
        .onedrive-section {
            background: #F0F7FF;
            border: 2px solid var(--onedrive);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .onedrive-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .onedrive-icon {
            font-size: 32px;
        }

        .onedrive-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--onedrive);
        }

        .onedrive-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: white;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .onedrive-status.connected {
            border: 2px solid var(--success);
            color: var(--success);
        }

        .onedrive-status.disconnected {
            border: 2px solid var(--text-light);
            color: var(--text-light);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
        }

        .onedrive-btn {
            width: 100%;
            padding: 14px;
            background: var(--onedrive);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .onedrive-btn:active {
            opacity: 0.8;
        }

        .onedrive-btn.disconnect {
            background: var(--danger);
            margin-top: 10px;
        }

        .onedrive-info {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 10px;
            line-height: 1.5;
        }

        /* Settings */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .settings-item {
            background: var(--bg);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-item-label {
            font-weight: 500;
        }

        .settings-item-value {
            color: var(--text-light);
            font-size: 14px;
        }

        .settings-button {
            width: 100%;
            padding: 14px;
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .settings-button:active {
            background: var(--border);
        }

        .settings-button.danger {
            color: var(--danger);
            border-color: var(--danger);
        }

        /* Activity Log Modal */
        .log-content {
            background: #1F2937;
            color: #E5E7EB;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        /* Token Warning Banner */
        .token-warning-banner {
            background: #FEF3C7;
            border-left: 4px solid #F59E0B;
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 8px;
            display: none;
        }

        .token-warning-banner.show {
            display: block;
        }

        .token-warning-text {
            font-size: 14px;
            color: #92400E;
            margin-bottom: 8px;
        }

        .token-warning-time {
            font-size: 12px;
            color: #B45309;
            font-weight: 600;
        }

        /* Sync Warning Modal */
        .sync-warning-modal {
            background: white;
            padding: 24px;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
        }

        .sync-warning-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 16px;
        }

        .sync-warning-title {
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 12px;
        }

        .sync-warning-message {
            color: var(--text-light);
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .sync-warning-times {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .sync-time-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .sync-time-label {
            color: var(--text-light);
        }

        .sync-time-value {
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .empty-message {
            font-size: 14px;
            line-height: 1.5;
        }

        /* File Path Display */
        .file-path-display {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-light);
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
        }

        .file-path-label {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .file-path-value {
            color: var(--onedrive);
        }

        /* File Browser Modal */
        .file-browser-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .file-browser-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .file-browser-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .file-breadcrumb {
            font-size: 13px;
            color: var(--text-light);
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: var(--bg);
        }

        .file-item:active {
            background: var(--border);
        }

        .file-icon {
            font-size: 28px;
            margin-right: 12px;
        }

        .file-name {
            flex: 1;
            font-weight: 500;
        }

        .file-size {
            font-size: 13px;
            color: var(--text-light);
        }

        .folder-item {
            border: 1px solid var(--border);
        }

        .json-file-item {
            background: #F0F7FF;
            border: 1px solid var(--onedrive);
        }

        .empty-folder {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .file-browser-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
        }

        /* Sale Modal Styles */
        .sale-channel-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            background: white;
            min-width: 0;
        }

        .sale-channel-select:focus {
            border-color: var(--primary);
        }

        .sale-info-box {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .sale-info-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .sale-info-sku {
            font-size: 13px;
            color: var(--text-light);
        }

        .sale-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 380px) {
            .sale-form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- PIN Screen -->
    <div class="pin-screen" id="pinScreen">
        <div class="pin-logo">üêÆ</div>
        <div class="pin-title">CCD Mobile Inventory</div>
        <div class="pin-input-container">
            <div class="pin-dot" id="dot1"></div>
            <div class="pin-dot" id="dot2"></div>
            <div class="pin-dot" id="dot3"></div>
            <div class="pin-dot" id="dot4"></div>
        </div>
        <div class="pin-keypad">
            <div class="pin-key" onclick="enterPin('1')">1</div>
            <div class="pin-key" onclick="enterPin('2')">2</div>
            <div class="pin-key" onclick="enterPin('3')">3</div>
            <div class="pin-key" onclick="enterPin('4')">4</div>
            <div class="pin-key" onclick="enterPin('5')">5</div>
            <div class="pin-key" onclick="enterPin('6')">6</div>
            <div class="pin-key" onclick="enterPin('7')">7</div>
            <div class="pin-key" onclick="enterPin('8')">8</div>
            <div class="pin-key" onclick="enterPin('9')">9</div>
            <div class="pin-key empty"></div>
            <div class="pin-key" onclick="enterPin('0')">0</div>
            <div class="pin-key backspace" onclick="backspacePin()">‚å´</div>
        </div>
        <div class="pin-error-msg" id="pinError"></div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="header-title">üêÆ CCD Inventory</div>
                <div class="header-actions">
                    <button class="header-btn" onclick="showSettings()" title="Settings">‚öôÔ∏è</button>
                </div>
            </div>
            <div class="sync-status" id="syncStatus">
                <div class="sync-dot" id="syncDot"></div>
                <span id="syncText">Not connected</span>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-bar">
            <input 
                type="text" 
                class="search-input" 
                id="searchInput" 
                placeholder="Search SKU, Product, or Brand..."
                oninput="applyFilters()"
            >
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Total Items</div>
                <div class="stat-value" id="statTotalItems">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Qty</div>
                <div class="stat-value" id="statTotalQty">0</div>
            </div>
        </div>

        <!-- Inventory List -->
        <div class="inventory-list" id="inventoryList">
            <div class="empty-state">
                <div class="empty-icon">üì¶</div>
                <div class="empty-title">No Inventory Loaded</div>
                <div class="empty-message">Connect to OneDrive in Settings to sync your inventory.</div>
            </div>
        </div>
    </div>

    <!-- Item Detail Modal -->
    <div class="modal" id="itemModal" onclick="closeItemModalOutside(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Item</div>
                <button class="modal-close" onclick="closeItemModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Product Name</label>
                    <input type="text" class="form-input" id="editProductName" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label">SKU</label>
                    <input type="text" class="form-input" id="editSku" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Brand</label>
                    <input type="text" class="form-input" id="editBrand" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Retail Price</label>
                    <input type="text" class="form-input" id="editRetailPrice" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Channel Allocation</label>
                    <div class="channel-inputs">
                        <div class="channel-input-group">
                            <label class="channel-input-label">Etsy</label>
                            <input type="number" class="channel-input" id="editEtsy" min="0" oninput="updateTotalQty()">
                        </div>
                        <div class="channel-input-group">
                            <label class="channel-input-label">Wix</label>
                            <input type="number" class="channel-input" id="editWix" min="0" oninput="updateTotalQty()">
                        </div>
                        <div class="channel-input-group">
                            <label class="channel-input-label">Wayfair</label>
                            <input type="number" class="channel-input" id="editWayfair" min="0" oninput="updateTotalQty()">
                        </div>
                        <div class="channel-input-group">
                            <label class="channel-input-label">TreasureMarts</label>
                            <input type="number" class="channel-input" id="editTreasureMarts" min="0" oninput="updateTotalQty()">
                        </div>
                    </div>
                    <div class="total-qty-display">
                        <div style="margin-bottom: 8px;">
                            <strong>Warehouse Qty:</strong> <span class="total-qty-number" id="warehouseQtyDisplay">0</span>
                        </div>
                        <div style="font-size: 13px;">
                            Allocated to Channels: <span id="totalQtyDisplay" style="font-weight: 600;">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-danger" onclick="markAsSold()">Mark as Sold</button>
                    <button class="btn btn-primary" onclick="saveItem()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal" onclick="closeSettingsOutside(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- OneDrive Connection Section -->
                <div class="onedrive-section">
                    <div class="onedrive-header">
                        <div class="onedrive-icon">‚òÅÔ∏è</div>
                        <div class="onedrive-title">OneDrive Sync</div>
                    </div>
                    
                    <div class="onedrive-status" id="connectionStatus">
                        <div class="status-dot"></div>
                        <span id="connectionStatusText">Not Connected</span>
                    </div>
                    
                    <div id="filePathInfo" style="display: none;">
                        <div class="file-path-display">
                            <div class="file-path-label">Current Master File:</div>
                            <div class="file-path-value" id="currentFilePath"></div>
                        </div>
                    </div>
                    
                    <button class="onedrive-btn" id="connectBtn" onclick="connectToOneDrive()">
                        <span>üìÅ</span>
                        <span>Connect to OneDrive</span>
                    </button>
                    
                    <button class="onedrive-btn disconnect" id="changeMasterBtn" style="display: none; background: var(--warning); margin-top: 10px;" onclick="changeMasterFile()">
                        <span>üîÑ</span>
                        <span>Change Master File</span>
                    </button>
                    
                    <button class="onedrive-btn disconnect" id="disconnectBtn" style="display: none;" onclick="disconnectOneDrive()">
                        <span>üîå</span>
                        <span>Disconnect OneDrive</span>
                    </button>
                    
                    <div class="onedrive-info">
                        Auto-sync enabled. Changes save automatically to OneDrive.
                    </div>
                </div>

                <!-- Sync Info Section -->
                <div class="settings-section">
                    <div class="settings-section-title">Sync Information</div>
                    <div class="settings-item">
                        <div class="settings-item-label">Last Sync</div>
                        <div class="settings-item-value" id="lastSyncDate">Never</div>
                    </div>
                </div>

                <!-- Actions Section -->
                <div class="settings-section">
                    <div class="settings-section-title">Actions</div>
                    <button class="settings-button" onclick="showTreasureMartReport()" style="background: #10B981; color: white;">üìä TreasureMart Report</button>
                    <button class="settings-button" onclick="showActivityLog()">üìã View Activity Log</button>
                    <button class="settings-button danger" onclick="confirmClearData()">üóëÔ∏è Clear Local Data</button>
                </div>

                <!-- Version Info -->
                <div class="settings-section">
                    <div class="settings-section-title">Version</div>
                    <div class="settings-item">
                        <div class="settings-item-label">App Version</div>
                        <div class="settings-item-value">v2.3.1</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Log Modal -->
    <div class="modal" id="logModal" onclick="closeLogModalOutside(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Activity Log</div>
                <button class="modal-close" onclick="closeLogModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="log-content" id="logContent"></div>
                <div class="log-actions">
                    <button class="btn btn-primary btn-full" onclick="copyLog()">üìã Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TreasureMart Report Modal -->
    <div class="modal" id="treasureMartModal" onclick="closeTreasureMartModalOutside(event)">
        <div class="modal-content" style="max-width: 600px; max-height: 95vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white;">
                <div class="modal-title">üìä TreasureMart Inventory</div>
                <button class="modal-close" onclick="closeTreasureMartModal()" style="color: white;">√ó</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Stats Bar -->
                <div style="padding: 12px 15px; background: #F0FDF4; border-bottom: 1px solid #D1FAE5;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                        <div>
                            <div style="font-size: 11px; color: #059669;">Total Items</div>
                            <div style="font-size: 20px; font-weight: 700; color: #047857;" id="tmTotalItems">0</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #059669;">Checked</div>
                            <div style="font-size: 20px; font-weight: 700; color: #047857;" id="tmCheckedCount">0</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #DC2626;">Missing</div>
                            <div style="font-size: 20px; font-weight: 700; color: #DC2626;" id="tmMissingCount">0</div>
                        </div>
                    </div>
                    <div style="margin-top: 8px; text-align: center;">
                        <span style="font-size: 13px; color: #059669;">Total Value: </span>
                        <span style="font-size: 16px; font-weight: 700; color: #047857;" id="tmTotalValue">$0.00</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="padding: 10px 15px; background: #F9FAFB; border-bottom: 1px solid #E5E7EB; display: flex; flex-wrap: wrap; gap: 8px;">
                    <button class="btn" onclick="exportTreasureMartPDF()" style="flex: 1; min-width: 100px; font-size: 13px; padding: 10px; background: #3B82F6; color: white;">üìÑ Print/PDF</button>
                    <button class="btn" onclick="exportTreasureMartExcel()" style="flex: 1; min-width: 100px; font-size: 13px; padding: 10px; background: #10B981; color: white;">üìä Excel</button>
                    <button class="btn" onclick="showMissingItemsReport()" style="flex: 1; min-width: 100px; font-size: 13px; padding: 10px; background: #DC2626; color: white;">‚ö†Ô∏è Missing</button>
                </div>
                
                <!-- Inventory List -->
                <div id="treasureMartList" style="max-height: 350px; overflow-y: auto; padding: 10px;"></div>
                
                <!-- Footer Actions -->
                <div style="padding: 10px 15px; border-top: 1px solid #E5E7EB; display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="resetTreasureMartAudit()" style="flex: 1; font-size: 13px;">üîÑ Reset Audit</button>
                    <button class="btn btn-primary" onclick="saveTreasureMartAudit()" style="flex: 1; font-size: 13px;">üíæ Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Missing Items Report Modal -->
    <div class="modal" id="missingItemsModal" onclick="closeMissingItemsModalOutside(event)">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%); color: white;">
                <div class="modal-title">‚ö†Ô∏è Missing Items Report</div>
                <button class="modal-close" onclick="closeMissingItemsModal()" style="color: white;">√ó</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div style="padding: 12px 15px; background: #FEF2F2; border-bottom: 1px solid #FECACA;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-size: 13px; color: #DC2626;">Total Missing: </span>
                            <span style="font-size: 20px; font-weight: 700; color: #DC2626;" id="missingTotalCount">0</span>
                        </div>
                        <div>
                            <span style="font-size: 13px; color: #DC2626;">Lost Value: </span>
                            <span style="font-size: 16px; font-weight: 700; color: #DC2626;" id="missingTotalValue">$0.00</span>
                        </div>
                    </div>
                </div>
                <div id="missingItemsList" style="max-height: 350px; overflow-y: auto; padding: 10px;"></div>
                <div style="padding: 10px 15px; border-top: 1px solid #E5E7EB;">
                    <button class="btn" onclick="copyMissingItemsReport()" style="width: 100%; background: #DC2626; color: white;">üìã Copy Missing Items Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Warning Modal -->
    <div class="modal" id="syncWarningModal" onclick="closeSyncWarningOutside(event)">
        <div class="sync-warning-modal">
            <div class="sync-warning-icon">‚ö†Ô∏è</div>
            <div class="sync-warning-title">File Changed on OneDrive</div>
            <div class="sync-warning-message">
                The inventory file on OneDrive has been modified by another device or user.
            </div>
            <div class="sync-warning-times">
                <div class="sync-time-row">
                    <span class="sync-time-label">Your version:</span>
                    <span class="sync-time-value" id="syncYourTime">-</span>
                </div>
                <div class="sync-time-row">
                    <span class="sync-time-label">OneDrive version:</span>
                    <span class="sync-time-value" id="syncFileTime">-</span>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeSyncWarning()">Keep Mine</button>
                <button class="btn btn-primary" onclick="reloadFromFile()">Load Latest</button>
            </div>
        </div>
    </div>

    <!-- File Browser Modal -->
    <div class="modal" id="fileBrowserModal" onclick="closeFileBrowserOutside(event)">
        <div class="file-browser-modal">
            <div class="file-browser-header">
                <div class="file-browser-title">Select Master JSON File</div>
                <div class="file-breadcrumb" id="fileBreadcrumb">OneDrive</div>
            </div>
            <div class="file-list" id="fileList">
                <div class="empty-folder">Loading...</div>
            </div>
            <div class="file-browser-footer">
                <button class="btn btn-secondary" onclick="closeFileBrowser()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Sale Details Modal -->
    <div class="modal" id="saleModal" onclick="closeSaleModalOutside(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Record Sale</div>
                <button class="modal-close" onclick="closeSaleModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="sale-info-box">
                    <div class="sale-info-title" id="saleItemName">Product Name</div>
                    <div class="sale-info-sku" id="saleItemSku">SKU: 00000</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Channel Sold From</label>
                    <select class="sale-channel-select" id="saleChannel" onchange="updateSalePrice()">
                        <option value="etsy">Etsy</option>
                        <option value="wix">Wix</option>
                        <option value="wayfair">Wayfair</option>
                        <option value="treasuremarts">TreasureMarts</option>
                    </select>
                </div>
                
                <div class="sale-form-row">
                    <div class="form-group">
                        <label class="form-label">Quantity Sold</label>
                        <input type="number" class="form-input" id="saleQty" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sale Price ($)</label>
                        <input type="number" class="form-input" id="salePrice" min="0" step="0.01" placeholder="0.00">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sale Date</label>
                    <input type="date" class="form-input" id="saleDate">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes (optional)</label>
                    <input type="text" class="form-input" id="saleNotes" placeholder="Order #, customer name, etc.">
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="closeSaleModal()">Cancel</button>
                    <button class="btn btn-success" onclick="confirmSale()">Confirm Sale</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MSAL Library -->
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>

    <script>
        // ============================================================================
        // CONFIGURATION
        // ============================================================================
        
        const CORRECT_PIN = '1234';
        const CLIENT_ID = '26b4b76a-3480-455a-8c0f-91d5305f9c35';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = ['Files.ReadWrite', 'offline_access'];
        
        const CRAZY_CHICKS_RENT = 200;
        const TREASURE_MARTS_RENT = 250;
        const globalSurcharge = 7.0;
        const etsyOHFee = 10.0;
        const wixOHFee = 10.0;
        const wayfairOHFee = 10.0;
        const treasureMartsRentFee = 10.0;
        
        // ============================================================================
        // CHANNEL PRICE CALCULATION (Matches Desktop System)
        // ============================================================================
        
        function calculateChannelPrice(item, channel) {
            const wholesale = parseFloat(item.wholesalePrice) || 0;
            const ibPercent = parseFloat(item.ibShipping) || 0;
            const ib = wholesale * (ibPercent / 100);
            const tariff = parseFloat(item.tariff) || 0;
            const ob = parseFloat(item.obShipping) || 0;
            
            let retailPrice = 0;
            
            if (channel === 'etsy') {
                const overheadFee = (wholesale + ib + tariff + ob) * (etsyOHFee / 100);
                const surcharge = ob * (globalSurcharge / 100);
                const formulaBaseRetail = wholesale * 2; // 100% markup
                retailPrice = formulaBaseRetail + ib + tariff + ob + overheadFee + surcharge;
                
            } else if (channel === 'wix') {
                const overheadFee = (wholesale + ib + tariff + ob) * (wixOHFee / 100);
                const surcharge = ob * (globalSurcharge / 100);
                const formulaBaseRetail = wholesale * 2;
                retailPrice = formulaBaseRetail + ib + tariff + ob + overheadFee + surcharge;
                
            } else if (channel === 'wayfair') {
                const formulaBaseRetail = wholesale * 2;
                const recoveryFee = formulaBaseRetail * 0.04;
                const overheadFee = (wholesale + ib + tariff) * (wayfairOHFee / 100);
                retailPrice = formulaBaseRetail + ib + tariff + recoveryFee + overheadFee;
                
            } else if (channel === 'treasuremarts') {
                if (item.coopPrice && item.coopPrice > 0) {
                    retailPrice = item.coopPrice;
                } else {
                    const basePrice = wholesale * 2;
                    const commission = basePrice * 0.10;
                    const baseRetail = basePrice + ib + tariff + commission;
                    retailPrice = baseRetail / (1 - (treasureMartsRentFee / 100));
                }
            }
            
            // Apply channel-specific price adjustments
            const adjustment = (item.channelPriceAdjustments && item.channelPriceAdjustments[channel]) || 0;
            retailPrice += adjustment;
            
            return retailPrice;
        }
        
        // ============================================================================
        // STATE MANAGEMENT
        // ============================================================================
        
        let pinInput = '';
        let inventory = [];
        let filteredInventory = [];
        let salesHistory = [];
        let currentItem = null;
        let lastSyncTime = null;
        let autoSaveEnabled = false;
        let fileHandle = null;
        let lastFileModified = null;
        let activityLog = [];
        let offlineQueue = [];
        
        // OneDrive/MSAL state
        let msalInstance = null;
        let accessToken = null;
        let isConnected = false;
        let currentFileId = null;
        let currentFilePath = null;
        let tokenExpirationTime = null;
        let tokenHealthCheckInterval = null;

        // ============================================================================
        // ACTIVITY LOGGING
        // ============================================================================
        
        function logActivity(action, details) {
            const entry = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details
            };
            
            activityLog.push(entry);
            
            // Keep only last 100 entries
            if (activityLog.length > 100) {
                activityLog = activityLog.slice(-100);
            }
            
            // Save to localStorage
            try {
                localStorage.setItem('ccd_mobile_activity_log', JSON.stringify(activityLog));
            } catch (err) {
                console.error('Failed to save activity log:', err);
            }
        }
        
        function loadLogFromStorage() {
            try {
                const stored = localStorage.getItem('ccd_mobile_activity_log');
                if (stored) {
                    activityLog = JSON.parse(stored);
                }
            } catch (err) {
                console.error('Failed to load activity log:', err);
                activityLog = [];
            }
        }

        // ============================================================================
        // OFFLINE QUEUE MANAGEMENT
        // ============================================================================
        
        function loadOfflineQueue() {
            try {
                const stored = localStorage.getItem('ccd_mobile_offline_queue');
                if (stored) {
                    offlineQueue = JSON.parse(stored);
                    logActivity('OFFLINE_QUEUE_LOADED', { queueLength: offlineQueue.length });
                }
            } catch (err) {
                console.error('Failed to load offline queue:', err);
                offlineQueue = [];
            }
        }
        
        function saveOfflineQueue() {
            try {
                localStorage.setItem('ccd_mobile_offline_queue', JSON.stringify(offlineQueue));
            } catch (err) {
                console.error('Failed to save offline queue:', err);
            }
        }
        
        function addToOfflineQueue(change) {
            offlineQueue.push({
                timestamp: new Date().toISOString(),
                change: change
            });
            
            // Limit offline queue to 50 items (keep most recent)
            if (offlineQueue.length > 50) {
                offlineQueue = offlineQueue.slice(-50);
                logActivity('OFFLINE_QUEUE_TRIMMED', { newSize: 50 });
            }
            
            saveOfflineQueue();
            logActivity('ADDED_TO_OFFLINE_QUEUE', change);
            showToast('Saved offline - will sync when connected', 'warning');
        }
        
        async function syncOfflineQueue() {
            if (offlineQueue.length === 0 || !isConnected) return;
            
            logActivity('SYNCING_OFFLINE_QUEUE', { queueLength: offlineQueue.length });
            showToast(`Syncing ${offlineQueue.length} offline changes...`, 'warning');
            
            const processedChanges = [];
            
            for (const queuedItem of offlineQueue) {
                try {
                    // Apply the change to current inventory
                    const item = inventory.find(i => String(i.id) === String(queuedItem.change.itemId));
                    if (item) {
                        if (queuedItem.change.type === 'sold') {
                            item.channels = queuedItem.change.newAllocations;
                        } else if (queuedItem.change.type === 'edit') {
                            item.channels = queuedItem.change.newAllocations;
                        }
                    }
                    processedChanges.push(queuedItem);
                } catch (err) {
                    console.error('Error processing queued change:', err);
                    logActivity('OFFLINE_QUEUE_ERROR', { error: err.message, change: queuedItem });
                }
            }
            
            // Save the updated inventory to OneDrive
            if (processedChanges.length > 0) {
                try {
                    await saveInventoryToOneDrive();
                    
                    // Remove processed changes from queue
                    offlineQueue = offlineQueue.filter(q => !processedChanges.includes(q));
                    saveOfflineQueue();
                    
                    logActivity('OFFLINE_QUEUE_SYNCED', { syncedCount: processedChanges.length });
                    showToast(`Synced ${processedChanges.length} offline changes!`, 'success');
                } catch (err) {
                    console.error('Failed to sync offline queue:', err);
                    showToast('Failed to sync offline changes', 'error');
                }
            }
        }

        // ============================================================================
        // TOKEN HEALTH MONITORING
        // ============================================================================
        
        function createTokenWarningBanner() {
            const banner = document.createElement('div');
            banner.id = 'tokenWarningBanner';
            banner.className = 'token-warning-banner';
            banner.innerHTML = `
                <div class="token-warning-text">‚ö†Ô∏è Your session will expire soon</div>
                <div class="token-warning-time">Time remaining: <span id="tokenTimeRemaining">-</span></div>
            `;
            
            const header = document.querySelector('.header');
            if (header && header.nextSibling) {
                header.parentNode.insertBefore(banner, header.nextSibling);
            }
        }
        
        function startTokenHealthCheck() {
            if (tokenHealthCheckInterval) {
                clearInterval(tokenHealthCheckInterval);
            }
            
            tokenHealthCheckInterval = setInterval(() => {
                if (!tokenExpirationTime || !isConnected) {
                    hideTokenWarning();
                    return;
                }
                
                const now = Date.now();
                const timeRemaining = tokenExpirationTime - now;
                const minutesRemaining = Math.floor(timeRemaining / 60000);
                
                if (timeRemaining <= 300000) { // 5 minutes
                    showTokenWarning(minutesRemaining);
                } else {
                    hideTokenWarning();
                }
                
                // Auto-refresh if less than 2 minutes remaining
                if (timeRemaining <= 120000 && timeRemaining > 0) {
                    logActivity('AUTO_TOKEN_REFRESH', { minutesRemaining });
                    refreshToken();
                }
            }, 30000); // Check every 30 seconds
        }
        
        function showTokenWarning(minutes) {
            const banner = document.getElementById('tokenWarningBanner');
            const timeDisplay = document.getElementById('tokenTimeRemaining');
            
            if (banner && timeDisplay) {
                timeDisplay.textContent = `${minutes} minute${minutes !== 1 ? 's' : ''}`;
                banner.classList.add('show');
            }
        }
        
        function hideTokenWarning() {
            const banner = document.getElementById('tokenWarningBanner');
            if (banner) {
                banner.classList.remove('show');
            }
        }
        
        async function refreshToken() {
            try {
                logActivity('TOKEN_REFRESH_STARTED', {});
                
                const account = msalInstance.getAllAccounts()[0];
                if (!account) {
                    throw new Error('No account found');
                }
                
                const tokenRequest = {
                    scopes: SCOPES,
                    account: account
                };
                
                const response = await msalInstance.acquireTokenSilent(tokenRequest);
                accessToken = response.accessToken;
                tokenExpirationTime = response.expiresOn.getTime();
                
                logActivity('TOKEN_REFRESHED', { 
                    expiresIn: Math.floor((tokenExpirationTime - Date.now()) / 60000) + ' minutes'
                });
                
                hideTokenWarning();
                showToast('Session refreshed', 'success');
                
            } catch (err) {
                console.error('Token refresh failed:', err);
                logActivity('TOKEN_REFRESH_FAILED', { error: err.message });
                
                // If silent refresh fails, user needs to re-authenticate
                showToast('Session expired - please reconnect', 'error');
                disconnectOneDrive();
            }
        }

        // ============================================================================
        // MSAL INITIALIZATION & ONEDRIVE CONNECTION
        // ============================================================================
        
        async function initializeMsal() {
            const msalConfig = {
                auth: {
                    clientId: CLIENT_ID,
                    authority: 'https://login.microsoftonline.com/common',
                    redirectUri: REDIRECT_URI,
                    navigateToLoginRequestUrl: true
                },
                cache: {
                    cacheLocation: 'localStorage',
                    storeAuthStateInCookie: true
                },
                system: {
                    allowNativeBroker: false,
                    windowHashTimeout: 60000,
                    iframeHashTimeout: 10000,
                    loadFrameTimeout: 10000
                }
            };
            
            msalInstance = new msal.PublicClientApplication(msalConfig);
            await msalInstance.initialize();
            
            logActivity('MSAL_INITIALIZED', { redirectUri: REDIRECT_URI });
            
            // Handle redirect response FIRST before anything else
            try {
                const response = await msalInstance.handleRedirectPromise();
                if (response) {
                    accessToken = response.accessToken;
                    tokenExpirationTime = response.expiresOn.getTime();
                    
                    // Save token info to survive page reloads and Authenticator switches
                    localStorage.setItem('ccd_access_token', accessToken);
                    localStorage.setItem('ccd_token_expiration', tokenExpirationTime.toString());
                    
                    logActivity('REDIRECT_LOGIN_SUCCESS', { 
                        account: response.account.username,
                        expiresIn: Math.floor((tokenExpirationTime - Date.now()) / 60000) + ' minutes'
                    });
                    
                    // After successful login, let user select the file
                    await selectMasterFile();
                    return; // Don't try silent login if we just handled redirect
                }
            } catch (err) {
                logActivity('REDIRECT_LOGIN_ERROR', { error: err.message });
                console.error('Redirect error:', err);
            }
            
            // Check for saved token first (survives Authenticator app switch)
            const savedToken = localStorage.getItem('ccd_access_token');
            const savedExpiration = localStorage.getItem('ccd_token_expiration');
            
            if (savedToken && savedExpiration && parseInt(savedExpiration) > Date.now()) {
                accessToken = savedToken;
                tokenExpirationTime = parseInt(savedExpiration);
                
                // Verify token still works
                try {
                    const testResponse = await fetch('https://graph.microsoft.com/v1.0/me', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (testResponse.ok) {
                        logActivity('TOKEN_VALIDATED', { expiresIn: Math.floor((tokenExpirationTime - Date.now()) / 60000) + ' minutes' });
                        
                        // Token is valid, check if we have a saved file connection
                        const savedFileId = localStorage.getItem('ccd_onedrive_file_id');
                        const savedFilePath = localStorage.getItem('ccd_onedrive_file_path');
                        
                        if (savedFileId && savedFilePath) {
                            currentFileId = savedFileId;
                            currentFilePath = savedFilePath;
                            isConnected = true;
                            updateConnectionUI();
                            
                            logActivity('TOKEN_RESTORED', { 
                                filePath: savedFilePath,
                                expiresIn: Math.floor((tokenExpirationTime - Date.now()) / 60000) + ' minutes'
                            });
                            
                            await loadInventoryFromOneDrive();
                            startAutoSync();
                            startTokenHealthCheck();
                            return;
                        } else {
                            // Token valid but no file selected - open file browser
                            logActivity('TOKEN_VALID_NO_FILE', { message: 'Opening file browser' });
                            await selectMasterFile();
                            return;
                        }
                    } else {
                        // Token rejected by API
                        logActivity('TOKEN_REJECTED', { status: testResponse.status });
                        localStorage.removeItem('ccd_access_token');
                        localStorage.removeItem('ccd_token_expiration');
                    }
                } catch (err) {
                    // Token invalid, clear it
                    localStorage.removeItem('ccd_access_token');
                    localStorage.removeItem('ccd_token_expiration');
                    logActivity('SAVED_TOKEN_INVALID', { error: err.message });
                }
            }
            
            // Try to restore previous session via MSAL
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0 && !accessToken) {
                try {
                    const silentRequest = {
                        scopes: SCOPES,
                        account: accounts[0]
                    };
                    const response = await msalInstance.acquireTokenSilent(silentRequest);
                    accessToken = response.accessToken;
                    tokenExpirationTime = response.expiresOn.getTime();
                    
                    // Save token
                    localStorage.setItem('ccd_access_token', accessToken);
                    localStorage.setItem('ccd_token_expiration', tokenExpirationTime.toString());
                    
                    // Try to restore previous file connection
                    const savedFileId = localStorage.getItem('ccd_onedrive_file_id');
                    const savedFilePath = localStorage.getItem('ccd_onedrive_file_path');
                    
                    if (savedFileId && savedFilePath) {
                        currentFileId = savedFileId;
                        currentFilePath = savedFilePath;
                        isConnected = true;
                        updateConnectionUI();
                        
                        logActivity('SESSION_RESTORED', { 
                            filePath: savedFilePath,
                            expiresIn: Math.floor((tokenExpirationTime - Date.now()) / 60000) + ' minutes'
                        });
                        
                        await loadInventoryFromOneDrive();
                        startAutoSync();
                        startTokenHealthCheck();
                    }
                } catch (err) {
                    logActivity('SILENT_LOGIN_FAILED', { error: err.message });
                    console.error('Silent token acquisition failed:', err);
                }
            }
            
            updateConnectionUI();
        }
        
        async function connectToOneDrive() {
            try {
                logActivity('CONNECT_ONEDRIVE_CLICKED', {});
                
                // Mark that we're in the middle of auth (survives page reload)
                localStorage.setItem('ccd_auth_in_progress', 'true');
                
                const loginRequest = {
                    scopes: SCOPES,
                    prompt: 'select_account'
                };
                
                // Try popup first (better for mobile when it works)
                try {
                    const response = await msalInstance.loginPopup(loginRequest);
                    
                    // Popup succeeded
                    localStorage.removeItem('ccd_auth_in_progress');
                    accessToken = response.accessToken;
                    tokenExpirationTime = response.expiresOn.getTime();
                    
                    localStorage.setItem('ccd_access_token', accessToken);
                    localStorage.setItem('ccd_token_expiration', tokenExpirationTime.toString());
                    
                    logActivity('POPUP_LOGIN_SUCCESS', { 
                        account: response.account.username,
                        expiresIn: Math.floor((tokenExpirationTime - Date.now()) / 60000) + ' minutes'
                    });
                    
                    await selectMasterFile();
                    
                } catch (popupError) {
                    // Popup blocked or failed, fall back to redirect
                    logActivity('POPUP_FAILED_USING_REDIRECT', { error: popupError.message });
                    await msalInstance.loginRedirect(loginRequest);
                }
                
            } catch (err) {
                localStorage.removeItem('ccd_auth_in_progress');
                logActivity('ONEDRIVE_CONNECT_ERROR', { error: err.message });
                showToast('Connection failed: ' + err.message, 'error');
            }
        }
        
        // File browser state
        let currentFolderId = 'root';
        let folderStack = [];
        
        async function selectMasterFile() {
            try {
                logActivity('FILE_BROWSER_OPENED', {});
                
                if (!accessToken) {
                    showToast('Not authenticated - please connect first', 'error');
                    return;
                }
                
                // Reset browser state
                currentFolderId = 'root';
                folderStack = [];
                
                // Show file browser modal
                await showFileBrowser();
                
            } catch (err) {
                logActivity('FILE_BROWSER_ERROR', { error: err.message });
                showToast('Failed to open file browser: ' + err.message, 'error');
            }
        }
        
        async function showFileBrowser() {
            try {
                // Show modal immediately with loading state
                document.getElementById('fileBrowserModal').classList.add('active');
                document.getElementById('fileList').innerHTML = '<div class="empty-folder">Loading files...</div>';
                
                // Fetch files and folders
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${currentFolderId}/children?$orderby=name`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Token expired
                        localStorage.removeItem('ccd_access_token');
                        localStorage.removeItem('ccd_token_expiration');
                        accessToken = null;
                        showToast('Session expired - please reconnect', 'error');
                        closeFileBrowser();
                        updateConnectionUI();
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: Failed to list files`);
                }
                
                const data = await response.json();
                
                // Update breadcrumb
                const breadcrumb = document.getElementById('fileBreadcrumb');
                if (folderStack.length === 0) {
                    breadcrumb.textContent = 'OneDrive';
                } else {
                    breadcrumb.textContent = 'OneDrive / ' + folderStack.map(f => f.name).join(' / ');
                }
                
                // Render files and folders
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';
                
                // Add back button if not in root
                if (folderStack.length > 0) {
                    const backItem = document.createElement('div');
                    backItem.className = 'file-item folder-item';
                    backItem.innerHTML = `
                        <div class="file-icon">‚¨ÜÔ∏è</div>
                        <div class="file-name">.. (Go back)</div>
                    `;
                    backItem.onclick = () => navigateBack();
                    fileList.appendChild(backItem);
                }
                
                // Sort: folders first, then files
                const items = data.value || [];
                const folders = items.filter(item => item.folder);
                const files = items.filter(item => !item.folder && item.name.endsWith('.json'));
                
                // Add folders
                folders.forEach(folder => {
                    const folderItem = document.createElement('div');
                    folderItem.className = 'file-item folder-item';
                    folderItem.innerHTML = `
                        <div class="file-icon">üìÅ</div>
                        <div class="file-name">${folder.name}</div>
                    `;
                    folderItem.onclick = () => navigateToFolder(folder);
                    fileList.appendChild(folderItem);
                });
                
                // Add JSON files
                files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item json-file-item';
                    fileItem.innerHTML = `
                        <div class="file-icon">üìÑ</div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    `;
                    fileItem.onclick = () => selectFile(file);
                    fileList.appendChild(fileItem);
                });
                
                if (folders.length === 0 && files.length === 0) {
                    fileList.innerHTML = '<div class="empty-folder">No JSON files or folders found</div>';
                }
                
                logActivity('FILE_BROWSER_LOADED', { folderCount: folders.length, fileCount: files.length });
                
            } catch (err) {
                logActivity('FILE_BROWSER_LOAD_ERROR', { error: err.message });
                document.getElementById('fileList').innerHTML = `<div class="empty-folder" style="color: #DC2626;">Error: ${err.message}</div>`;
                showToast('Failed to load files: ' + err.message, 'error');
            }
        }
        
        async function navigateToFolder(folder) {
            folderStack.push({ id: folder.id, name: folder.name });
            currentFolderId = folder.id;
            await showFileBrowser();
        }
        
        async function navigateBack() {
            if (folderStack.length > 0) {
                folderStack.pop();
                currentFolderId = folderStack.length > 0 ? folderStack[folderStack.length - 1].id : 'root';
                await showFileBrowser();
            }
        }
        
        async function selectFile(file) {
            try {
                currentFileId = file.id;
                
                // Build full path
                let pathParts = folderStack.map(f => f.name);
                pathParts.push(file.name);
                currentFilePath = '/' + pathParts.join('/');
                
                // Save file info to localStorage
                localStorage.setItem('ccd_onedrive_file_id', currentFileId);
                localStorage.setItem('ccd_onedrive_file_path', currentFilePath);
                
                isConnected = true;
                updateConnectionUI();
                
                logActivity('FILE_SELECTED', { 
                    fileId: currentFileId, 
                    fileName: currentFilePath 
                });
                
                closeFileBrowser();
                closeSettings();
                
                await loadInventoryFromOneDrive();
                startAutoSync();
                startTokenHealthCheck();
                
                showToast('Connected to ' + file.name, 'success');
                
            } catch (err) {
                logActivity('FILE_SELECT_ERROR', { error: err.message });
                showToast('Failed to select file', 'error');
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function closeFileBrowser() {
            document.getElementById('fileBrowserModal').classList.remove('active');
        }
        
        function closeFileBrowserOutside(event) {
            if (event.target === event.currentTarget) {
                closeFileBrowser();
            }
        }
        
        async function changeMasterFile() {
            try {
                logActivity('CHANGE_MASTER_FILE_CLICKED', {});
                
                // Clear current file info but keep auth
                currentFileId = null;
                currentFilePath = null;
                localStorage.removeItem('ccd_onedrive_file_id');
                localStorage.removeItem('ccd_onedrive_file_path');
                
                // Open file picker to select new file
                await selectMasterFile();
                
            } catch (err) {
                logActivity('CHANGE_MASTER_FILE_ERROR', { error: err.message });
                showToast('Failed to change file: ' + err.message, 'error');
            }
        }
        
        function disconnectOneDrive() {
            logActivity('DISCONNECT_ONEDRIVE', {});
            
            if (tokenHealthCheckInterval) {
                clearInterval(tokenHealthCheckInterval);
                tokenHealthCheckInterval = null;
            }
            
            hideTokenWarning();
            
            accessToken = null;
            tokenExpirationTime = null;
            isConnected = false;
            currentFileId = null;
            currentFilePath = null;
            autoSaveEnabled = false;
            
            localStorage.removeItem('ccd_onedrive_file_id');
            localStorage.removeItem('ccd_onedrive_file_path');
            
            if (msalInstance) {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    msalInstance.logoutRedirect({ account: accounts[0] });
                }
            }
            
            updateConnectionUI();
            updateSyncStatus('Not connected', false);
            showToast('Disconnected from OneDrive', 'success');
        }
        
        function updateConnectionUI() {
            const statusDiv = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionStatusText');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const changeMasterBtn = document.getElementById('changeMasterBtn');
            const filePathInfo = document.getElementById('filePathInfo');
            const currentFilePathSpan = document.getElementById('currentFilePath');
            
            if (isConnected && currentFilePath) {
                statusDiv.className = 'onedrive-status connected';
                statusText.textContent = 'Connected';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
                changeMasterBtn.style.display = 'block';
                filePathInfo.style.display = 'block';
                currentFilePathSpan.textContent = currentFilePath;
            } else if (accessToken) {
                // Authenticated but no file selected
                statusDiv.className = 'onedrive-status disconnected';
                statusText.textContent = 'Authenticated - Select File';
                connectBtn.innerHTML = '<span>üìÅ</span><span>Select Master JSON File</span>';
                connectBtn.onclick = selectMasterFile;
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'block';
                changeMasterBtn.style.display = 'none';
                filePathInfo.style.display = 'none';
            } else {
                statusDiv.className = 'onedrive-status disconnected';
                statusText.textContent = 'Not Connected';
                connectBtn.innerHTML = '<span>üìÅ</span><span>Connect to OneDrive</span>';
                connectBtn.onclick = connectToOneDrive;
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
                changeMasterBtn.style.display = 'none';
                filePathInfo.style.display = 'none';
            }
        }

        // ============================================================================
        // ONEDRIVE SYNC OPERATIONS
        // ============================================================================
        
        async function loadInventoryFromOneDrive() {
            if (!accessToken || !currentFileId) {
                logActivity('LOAD_FAILED_NO_AUTH', {});
                return;
            }
            
            try {
                updateSyncStatus('Loading...', true);
                
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${currentFileId}/content`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                const data = JSON.parse(text);
                
                inventory = data.inventory || [];
                
                logActivity('INVENTORY_LOADED', { 
                    itemCount: inventory.length,
                    source: 'OneDrive'
                });
                
                applyFilters();
                updateStats();
                updateSyncStatus('Synced', false);
                
                lastSyncTime = new Date();
                localStorage.setItem('ccd_mobile_last_sync', lastSyncTime.toISOString());
                
                // Try to sync any pending offline changes
                if (offlineQueue.length > 0) {
                    setTimeout(syncOfflineQueue, 1000);
                }
                
            } catch (err) {
                logActivity('LOAD_ERROR', { error: err.message });
                updateSyncStatus('Load failed', false);
                showToast('Failed to load: ' + err.message, 'error');
            }
        }
        
        async function saveInventoryToOneDrive() {
            if (!accessToken || !currentFileId) {
                logActivity('SAVE_FAILED_NO_AUTH', {});
                addToOfflineQueue({ type: 'full_save', inventory: inventory });
                return;
            }
            
            try {
                updateSyncStatus('Saving...', true);
                
                const jsonData = JSON.stringify({ inventory: inventory }, null, 2);
                
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${currentFileId}/content`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: jsonData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                logActivity('INVENTORY_SAVED', { 
                    itemCount: inventory.length,
                    destination: 'OneDrive'
                });
                
                updateSyncStatus('Synced', false);
                
                lastSyncTime = new Date();
                localStorage.setItem('ccd_mobile_last_sync', lastSyncTime.toISOString());
                
                return true;
                
            } catch (err) {
                logActivity('SAVE_ERROR', { error: err.message });
                updateSyncStatus('Save failed', false);
                showToast('Save failed: ' + err.message, 'error');
                
                // Add to offline queue if save failed
                addToOfflineQueue({ type: 'full_save', inventory: inventory });
                return false;
            }
        }
        
        function startAutoSync() {
            autoSaveEnabled = true;
            
            // Auto-sync every 30 seconds
            setInterval(async () => {
                if (autoSaveEnabled && isConnected) {
                    await loadInventoryFromOneDrive();
                }
            }, 30000);
        }
        
        function updateSyncStatus(message, isSyncing) {
            const statusText = document.getElementById('syncText');
            const syncDot = document.getElementById('syncDot');
            
            statusText.textContent = message;
            
            if (isSyncing) {
                syncDot.className = 'sync-dot syncing';
            } else if (message.includes('failed') || message.includes('error')) {
                syncDot.className = 'sync-dot error';
            } else if (isConnected) {
                syncDot.className = 'sync-dot';
            } else {
                syncDot.className = 'sync-dot error';
            }
        }

        // ============================================================================
        // PIN AUTHENTICATION
        // ============================================================================
        
        function enterPin(digit) {
            if (pinInput.length < 4) {
                pinInput += digit;
                updatePinDots();
                
                if (pinInput.length === 4) {
                    checkPin();
                }
            }
        }
        
        function backspacePin() {
            pinInput = pinInput.slice(0, -1);
            updatePinDots();
            clearPinError();
        }
        
        function updatePinDots() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById('dot' + i);
                if (i <= pinInput.length) {
                    dot.classList.add('filled');
                } else {
                    dot.classList.remove('filled');
                }
                dot.classList.remove('error');
            }
        }
        
        function checkPin() {
            if (pinInput === CORRECT_PIN) {
                sessionStorage.setItem('ccd_mobile_auth', 'true');
                document.getElementById('pinScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.add('active');
                
                logActivity('PIN_LOGIN_SUCCESS', {});
                
                // Initialize MSAL after successful PIN
                initializeMsal().then(() => {
                    if (!isConnected) {
                        loadFromStorage();
                    }
                    
                    // Start token health monitoring if connected
                    if (isConnected) {
                        startTokenHealthCheck();
                        
                        // Check for offline changes
                        if (offlineQueue.length > 0) {
                            setTimeout(syncOfflineQueue, 2000);
                        }
                    }
                });
            } else {
                showPinError();
                logActivity('PIN_LOGIN_FAILED', {});
            }
        }
        
        function showPinError() {
            for (let i = 1; i <= 4; i++) {
                document.getElementById('dot' + i).classList.add('error');
            }
            document.getElementById('pinError').textContent = 'Incorrect PIN';
            pinInput = '';
            
            setTimeout(() => {
                updatePinDots();
                clearPinError();
            }, 1000);
        }
        
        function clearPinError() {
            document.getElementById('pinError').textContent = '';
        }

        // ============================================================================
        // INVENTORY MANAGEMENT
        // ============================================================================
        
        function loadFromStorage() {
            const stored = localStorage.getItem('ccd_mobile_inventory');
            if (stored) {
                try {
                    inventory = JSON.parse(stored);
                    applyFilters();
                    updateStats();
                    logActivity('LOADED_FROM_STORAGE', { itemCount: inventory.length });
                } catch (err) {
                    logActivity('STORAGE_LOAD_ERROR', { error: err.message });
                }
            }
        }
        
        function saveToStorage() {
            try {
                localStorage.setItem('ccd_mobile_inventory', JSON.stringify(inventory));
            } catch (err) {
                logActivity('STORAGE_SAVE_ERROR', { error: err.message });
            }
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredInventory = inventory.filter(item => {
                const matchesSearch = !searchTerm || 
                    (item.sku && item.sku.toLowerCase().includes(searchTerm)) ||
                    (item.productName && item.productName.toLowerCase().includes(searchTerm)) ||
                    (item.brandName && item.brandName.toLowerCase().includes(searchTerm));
                
                return matchesSearch;
            });
            
            renderInventoryList();
        }
        
        function renderInventoryList() {
            const listDiv = document.getElementById('inventoryList');
            
            if (filteredInventory.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-title">No Items Found</div>
                        <div class="empty-message">Try adjusting your search or connect to OneDrive to load inventory.</div>
                    </div>
                `;
                return;
            }
            
            listDiv.innerHTML = filteredInventory.map(item => {
                const warehouseQty = getTotalQty(item);
                const channels = item.channels || {};
                const allocatedQty = getChannelAllocationsTotal(item);
                
                // Calculate channel-specific prices using the formula
                const etsyPrice = calculateChannelPrice(item, 'etsy');
                const wixPrice = calculateChannelPrice(item, 'wix');
                const wayfairPrice = calculateChannelPrice(item, 'wayfair');
                const treasuremartsPrice = calculateChannelPrice(item, 'treasuremarts');
                
                return `
                    <div class="inventory-item" onclick="openItemModal('${item.id}')">
                        <div class="item-header">
                            <div>
                                <div class="item-title">${item.productName || 'Unnamed Product'}</div>
                                <div class="item-sku">SKU: ${item.sku || 'N/A'} | ${item.brandName || 'No Brand'}</div>
                            </div>
                            <div class="item-qty">${warehouseQty}</div>
                        </div>
                        <div class="item-details">
                            <div class="detail-item">
                                <span class="detail-label">Retail Price:</span>
                                <span class="detail-value">$${(parseFloat(item.retailPrice) || 0).toFixed(2)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Shelf:</span>
                                <span class="detail-value">${item.shelfNumber || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="item-channels">
                            <div class="channel-row">
                                <span class="channel-label">Etsy:</span>
                                <span class="channel-qty">${channels.etsy || 0}</span>
                                <span class="channel-price">$${etsyPrice.toFixed(2)}</span>
                            </div>
                            <div class="channel-row">
                                <span class="channel-label">Wix:</span>
                                <span class="channel-qty">${channels.wix || 0}</span>
                                <span class="channel-price">$${wixPrice.toFixed(2)}</span>
                            </div>
                            <div class="channel-row">
                                <span class="channel-label">Wayfair:</span>
                                <span class="channel-qty">${channels.wayfair || 0}</span>
                                <span class="channel-price">$${wayfairPrice.toFixed(2)}</span>
                            </div>
                            <div class="channel-row">
                                <span class="channel-label">TreasureMarts:</span>
                                <span class="channel-qty">${channels.treasuremarts || 0}</span>
                                <span class="channel-price">$${treasuremartsPrice.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateStats() {
            const totalItems = inventory.length;
            const totalQty = inventory.reduce((sum, item) => sum + getTotalQty(item), 0);
            
            document.getElementById('statTotalItems').textContent = totalItems;
            document.getElementById('statTotalQty').textContent = totalQty;
        }
        
        function getTotalQty(item) {
            // Use the qty field from the master JSON (warehouse total)
            // Channel quantities are allocations FROM this total
            return parseInt(item.qty) || 0;
        }
        
        function getChannelAllocationsTotal(item) {
            // Sum of what's allocated to channels (for display purposes)
            const channels = item.channels || {};
            return (channels.etsy || 0) + (channels.wix || 0) + (channels.wayfair || 0) + (channels.treasuremarts || 0);
        }
        
        function openItemModal(itemId) {
            // Handle both string and numeric IDs
            currentItem = inventory.find(i => String(i.id) === String(itemId));
            
            if (!currentItem) {
                showToast('Item not found', 'error');
                return;
            }
            
            // Use retail price directly from the item
            const retailPrice = parseFloat(currentItem.retailPrice) || 0;
            
            document.getElementById('editProductName').value = currentItem.productName || '';
            document.getElementById('editSku').value = currentItem.sku || '';
            document.getElementById('editBrand').value = currentItem.brandName || '';
            document.getElementById('editRetailPrice').value = '$' + retailPrice.toFixed(2);
            
            const channels = currentItem.channels || {};
            document.getElementById('editEtsy').value = channels.etsy || 0;
            document.getElementById('editWix').value = channels.wix || 0;
            document.getElementById('editWayfair').value = channels.wayfair || 0;
            document.getElementById('editTreasureMarts').value = channels.treasuremarts || 0;
            
            // Show warehouse qty (from master JSON qty field)
            const warehouseQty = parseInt(currentItem.qty) || 0;
            document.getElementById('warehouseQtyDisplay').textContent = warehouseQty;
            
            updateTotalQty();
            
            document.getElementById('itemModal').classList.add('active');
        }
        
        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('active');
            currentItem = null;
        }
        
        function closeItemModalOutside(event) {
            if (event.target === event.currentTarget) {
                closeItemModal();
            }
        }
        
        function updateTotalQty() {
            const etsy = parseInt(document.getElementById('editEtsy').value) || 0;
            const wix = parseInt(document.getElementById('editWix').value) || 0;
            const wayfair = parseInt(document.getElementById('editWayfair').value) || 0;
            const treasure = parseInt(document.getElementById('editTreasureMarts').value) || 0;
            
            const total = etsy + wix + wayfair + treasure;
            document.getElementById('totalQtyDisplay').textContent = total;
        }
        
        async function saveItem() {
            if (!currentItem) return;
            
            const newAllocations = {
                etsy: parseInt(document.getElementById('editEtsy').value) || 0,
                wix: parseInt(document.getElementById('editWix').value) || 0,
                wayfair: parseInt(document.getElementById('editWayfair').value) || 0,
                treasuremarts: parseInt(document.getElementById('editTreasureMarts').value) || 0
            };
            
            // Preserve existing channels that aren't in the mobile app (like crazychicks)
            currentItem.channels = {
                ...currentItem.channels,
                ...newAllocations
            };
            
            logActivity('ITEM_EDITED', { 
                itemId: currentItem.id, 
                sku: currentItem.sku,
                newAllocations: newAllocations 
            });
            
            applyFilters();
            updateStats();
            saveToStorage();
            
            if (isConnected) {
                await saveInventoryToOneDrive();
            } else {
                addToOfflineQueue({
                    type: 'edit',
                    itemId: currentItem.id,
                    newAllocations: newAllocations
                });
            }
            
            closeItemModal();
            showToast('Item updated!', 'success');
        }
        
        async function markAsSold() {
            if (!currentItem) return;
            
            // Open the sale details modal instead of immediate confirmation
            openSaleModal();
        }
        
        function openSaleModal() {
            // Populate sale modal with current item info
            document.getElementById('saleItemName').textContent = currentItem.productName || 'Unnamed Product';
            document.getElementById('saleItemSku').textContent = 'SKU: ' + (currentItem.sku || 'N/A');
            
            // Set default values
            document.getElementById('saleQty').value = 1;
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0]; // Today
            document.getElementById('saleNotes').value = '';
            
            // Set default channel based on which has inventory
            const channels = currentItem.channels || {};
            if (channels.etsy > 0) document.getElementById('saleChannel').value = 'etsy';
            else if (channels.wix > 0) document.getElementById('saleChannel').value = 'wix';
            else if (channels.wayfair > 0) document.getElementById('saleChannel').value = 'wayfair';
            else if (channels.treasuremarts > 0) document.getElementById('saleChannel').value = 'treasuremarts';
            
            // Update price based on selected channel
            updateSalePrice();
            
            // Close item modal and open sale modal
            document.getElementById('itemModal').classList.remove('active');
            document.getElementById('saleModal').classList.add('active');
        }
        
        function updateSalePrice() {
            const channel = document.getElementById('saleChannel').value;
            const price = calculateChannelPrice(currentItem, channel);
            document.getElementById('salePrice').value = price.toFixed(2);
        }
        
        function closeSaleModal() {
            document.getElementById('saleModal').classList.remove('active');
        }
        
        function closeSaleModalOutside(event) {
            if (event.target === event.currentTarget) {
                closeSaleModal();
            }
        }
        
        async function confirmSale() {
            if (!currentItem) return;
            
            const channel = document.getElementById('saleChannel').value;
            const qtySold = parseInt(document.getElementById('saleQty').value) || 1;
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
            const saleDate = document.getElementById('saleDate').value;
            const saleNotes = document.getElementById('saleNotes').value;
            
            const channels = currentItem.channels || {};
            const currentChannelQty = channels[channel] || 0;
            
            // Check if we have enough inventory
            if (qtySold > currentChannelQty) {
                if (!confirm(`Only ${currentChannelQty} available in ${channel}. Proceed anyway?`)) {
                    return;
                }
            }
            
            const oldAllocations = { ...currentItem.channels };
            const oldWarehouseQty = parseInt(currentItem.qty) || 0;
            
            // Deduct from channel allocation
            const newChannelQty = Math.max(0, currentChannelQty - qtySold);
            currentItem.channels = {
                ...currentItem.channels,
                [channel]: newChannelQty
            };
            
            // Also deduct from warehouse qty
            currentItem.qty = Math.max(0, oldWarehouseQty - qtySold);
            
            const saleRecord = {
                timestamp: new Date().toISOString(),
                saleDate: saleDate,
                item: { 
                    id: currentItem.id,
                    sku: currentItem.sku,
                    productName: currentItem.productName
                },
                channel: channel,
                qtySold: qtySold,
                salePrice: salePrice,
                notes: saleNotes,
                previousAllocations: oldAllocations,
                previousWarehouseQty: oldWarehouseQty
            };
            
            logActivity('ITEM_SOLD', { 
                itemId: currentItem.id, 
                sku: currentItem.sku,
                productName: currentItem.productName,
                channel: channel,
                qtySold: qtySold,
                salePrice: salePrice,
                previousAllocations: oldAllocations,
                previousWarehouseQty: oldWarehouseQty
            });
            
            salesHistory.push(saleRecord);
            localStorage.setItem('ccd_mobile_sales', JSON.stringify(salesHistory));
            
            applyFilters();
            updateStats();
            saveToStorage();
            
            if (isConnected) {
                const saved = await saveInventoryToOneDrive();
                if (saved) {
                    closeSaleModal();
                    showToast(`Sold ${qtySold} from ${channel} for $${salePrice.toFixed(2)}!`, 'success');
                } else {
                    showToast('Sale recorded locally - sync failed', 'warning');
                    closeSaleModal();
                }
            } else {
                addToOfflineQueue({
                    type: 'sold',
                    itemId: currentItem.id,
                    channel: channel,
                    qtySold: qtySold,
                    newChannels: currentItem.channels,
                    newQty: currentItem.qty
                });
                closeSaleModal();
                showToast('Sale saved offline - will sync when connected', 'warning');
            }
        }
        
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return date.toLocaleDateString();
        }

        // ============================================================================
        // SETTINGS
        // ============================================================================
        
        function showSettings() {
            try {
                // Update connection status display
                updateConnectionUI();
                
                // Update last sync time
                if (lastSyncTime) {
                    document.getElementById('lastSyncDate').textContent = formatTime(lastSyncTime);
                }
                
                document.getElementById('settingsModal').classList.add('active');
            } catch (error) {
                alert('Settings error: ' + error.message);
                console.error('Settings error:', error);
            }
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }
        
        function closeSettingsOutside(event) {
            if (event.target === event.currentTarget) {
                closeSettings();
            }
        }
        
        function confirmClearData() {
            if (confirm('Clear all local data? This cannot be undone.')) {
                localStorage.removeItem('ccd_mobile_inventory');
                localStorage.removeItem('ccd_mobile_sales');
                localStorage.removeItem('ccd_mobile_last_sync');
                inventory = [];
                salesHistory = [];
                filteredInventory = [];
                applyFilters();
                updateStats();
                closeSettings();
                showToast('Local data cleared', 'success');
            }
        }

        // ============================================================================
        // ACTIVITY LOG VIEWER
        // ============================================================================
        
        function showActivityLog() {
            const logContent = document.getElementById('logContent');
            
            if (activityLog.length === 0) {
                logContent.textContent = 'No activity logged yet.';
            } else {
                // Show most recent first, formatted nicely
                const formatted = activityLog.slice().reverse().map(entry => {
                    const time = new Date(entry.timestamp).toLocaleString();
                    const details = JSON.stringify(entry.details, null, 2);
                    return `[${time}]\n${entry.action}\n${details}\n${'‚îÄ'.repeat(30)}`;
                }).join('\n\n');
                
                logContent.textContent = formatted;
            }
            
            closeSettings();
            document.getElementById('logModal').classList.add('active');
        }
        
        function closeLogModal() {
            document.getElementById('logModal').classList.remove('active');
        }
        
        function closeLogModalOutside(event) {
            if (event.target === event.currentTarget) {
                closeLogModal();
            }
        }
        
        function copyLog() {
            const logText = activityLog.slice().reverse().map(entry => {
                return `[${entry.timestamp}] ${entry.action}: ${JSON.stringify(entry.details)}`;
            }).join('\n');
            
            navigator.clipboard.writeText(logText).then(() => {
                showToast('Log copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy log', 'error');
            });
        }

        // ============================================================================
        // TREASUREMART INVENTORY AUDIT
        // ============================================================================
        
        // Track audit state - persists during session
        let treasureMartAudit = {};  // { itemId: 'found' | 'missing' }
        let auditChanges = [];       // Track changes to save
        
        function loadTreasureMartAudit() {
            try {
                const saved = localStorage.getItem('ccd_tm_audit');
                if (saved) {
                    treasureMartAudit = JSON.parse(saved);
                }
            } catch (err) {
                treasureMartAudit = {};
            }
        }
        
        function saveTreasureMartAuditState() {
            try {
                localStorage.setItem('ccd_tm_audit', JSON.stringify(treasureMartAudit));
            } catch (err) {
                console.error('Failed to save audit state:', err);
            }
        }
        
        function showTreasureMartReport() {
            loadTreasureMartAudit();
            
            // Filter items that have TreasureMart allocation > 0
            const tmItems = inventory.filter(item => {
                const channels = item.channels || {};
                return (channels.treasuremarts || 0) > 0;
            });
            
            // Sort by shelf number, then product name
            tmItems.sort((a, b) => {
                const shelfA = a.shelfNumber || 'ZZZ';
                const shelfB = b.shelfNumber || 'ZZZ';
                if (shelfA !== shelfB) return shelfA.localeCompare(shelfB);
                return (a.productName || '').localeCompare(b.productName || '');
            });
            
            // Calculate totals
            let totalItems = 0;
            let totalValue = 0;
            let checkedCount = 0;
            let missingCount = 0;
            
            const listDiv = document.getElementById('treasureMartList');
            
            if (tmItems.length === 0) {
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #6B7280;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>
                        <div style="font-size: 16px; font-weight: 600;">No TreasureMart Inventory</div>
                        <div style="font-size: 14px; margin-top: 5px;">No items are currently allocated to TreasureMarts.</div>
                    </div>
                `;
            } else {
                listDiv.innerHTML = tmItems.map(item => {
                    const channels = item.channels || {};
                    const qty = channels.treasuremarts || 0;
                    const price = calculateChannelPrice(item, 'treasuremarts');
                    const lineTotal = qty * price;
                    
                    totalItems += qty;
                    totalValue += lineTotal;
                    
                    const auditStatus = treasureMartAudit[item.id] || 'unchecked';
                    if (auditStatus === 'found') checkedCount += qty;
                    if (auditStatus === 'missing') missingCount += qty;
                    
                    const isMissing = auditStatus === 'missing';
                    const isFound = auditStatus === 'found';
                    
                    const bgColor = isMissing ? '#FEF2F2' : (isFound ? '#F0FDF4' : 'white');
                    const borderColor = isMissing ? '#FECACA' : (isFound ? '#A7F3D0' : '#E5E7EB');
                    
                    return `
                        <div id="tm-item-${item.id}" style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; padding: 10px; margin-bottom: 8px; ${isMissing ? 'opacity: 0.9;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 14px; ${isMissing ? 'color: #DC2626; text-decoration: line-through;' : ''}">${item.productName || 'Unnamed'}</div>
                                    <div style="font-size: 12px; color: #6B7280;">SKU: ${item.sku || 'N/A'} | Shelf: ${item.shelfNumber || 'N/A'}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; color: ${isMissing ? '#DC2626' : '#047857'}; font-size: 16px;">√ó${qty}</div>
                                    <div style="font-size: 12px; color: #6B7280;">$${price.toFixed(2)}</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="markTMItemFound('${item.id}')" 
                                    style="flex: 1; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: 2px solid ${isFound ? '#10B981' : '#D1D5DB'}; background: ${isFound ? '#10B981' : 'white'}; color: ${isFound ? 'white' : '#374151'};">
                                    ‚úì Found
                                </button>
                                <button onclick="markTMItemMissing('${item.id}')" 
                                    style="flex: 1; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: 2px solid ${isMissing ? '#DC2626' : '#D1D5DB'}; background: ${isMissing ? '#DC2626' : 'white'}; color: ${isMissing ? 'white' : '#374151'};">
                                    ‚úó Missing
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Update totals
            document.getElementById('tmTotalItems').textContent = totalItems;
            document.getElementById('tmCheckedCount').textContent = checkedCount;
            document.getElementById('tmMissingCount').textContent = missingCount;
            document.getElementById('tmTotalValue').textContent = '$' + totalValue.toFixed(2);
            
            closeSettings();
            document.getElementById('treasureMartModal').classList.add('active');
            
            logActivity('TREASUREMART_REPORT_VIEWED', { itemCount: tmItems.length, totalQty: totalItems, totalValue: totalValue.toFixed(2) });
        }
        
        function markTMItemFound(itemId) {
            treasureMartAudit[itemId] = 'found';
            saveTreasureMartAuditState();
            
            // Refresh the display
            showTreasureMartReport();
        }
        
        function markTMItemMissing(itemId) {
            const item = inventory.find(i => String(i.id) === String(itemId));
            if (!item) return;
            
            // Confirm before marking missing
            if (!confirm(`Mark "${item.productName}" as MISSING?\n\nThis will deduct 1 from TreasureMart inventory when you save.`)) {
                return;
            }
            
            treasureMartAudit[itemId] = 'missing';
            
            // Track the change to apply on save
            if (!auditChanges.find(c => c.itemId === itemId)) {
                auditChanges.push({
                    itemId: itemId,
                    action: 'missing',
                    sku: item.sku,
                    productName: item.productName
                });
            }
            
            saveTreasureMartAuditState();
            showTreasureMartReport();
        }
        
        function resetTreasureMartAudit() {
            if (!confirm('Reset all audit checkmarks? This will clear Found/Missing status for all items.')) {
                return;
            }
            
            treasureMartAudit = {};
            auditChanges = [];
            localStorage.removeItem('ccd_tm_audit');
            
            showTreasureMartReport();
            showToast('Audit reset', 'success');
        }
        
        async function saveTreasureMartAudit() {
            if (auditChanges.length === 0) {
                showToast('No missing items to save', 'warning');
                return;
            }
            
            const missingItems = auditChanges.filter(c => c.action === 'missing');
            
            if (!confirm(`Save audit results?\n\nThis will deduct inventory for ${missingItems.length} missing item(s).`)) {
                return;
            }
            
            // Apply the changes to inventory
            for (const change of missingItems) {
                const item = inventory.find(i => String(i.id) === String(change.itemId));
                if (item && item.channels) {
                    const currentQty = item.channels.treasuremarts || 0;
                    item.channels.treasuremarts = Math.max(0, currentQty - 1);
                    
                    // Also deduct from warehouse qty
                    const warehouseQty = parseInt(item.qty) || 0;
                    item.qty = Math.max(0, warehouseQty - 1);
                    
                    logActivity('TM_ITEM_MARKED_MISSING', {
                        itemId: item.id,
                        sku: item.sku,
                        productName: item.productName,
                        previousQty: currentQty,
                        newQty: item.channels.treasuremarts
                    });
                }
            }
            
            // Save to OneDrive
            if (isConnected) {
                const saved = await saveInventoryToOneDrive();
                if (saved) {
                    // Clear the audit changes (keep the checkmarks for reference)
                    auditChanges = [];
                    showToast(`Saved! ${missingItems.length} item(s) deducted from inventory`, 'success');
                } else {
                    showToast('Failed to save to OneDrive', 'error');
                }
            } else {
                saveToStorage();
                auditChanges = [];
                showToast('Saved locally (not connected to OneDrive)', 'warning');
            }
            
            // Refresh displays
            applyFilters();
            updateStats();
            showTreasureMartReport();
        }
        
        function closeTreasureMartModal() {
            document.getElementById('treasureMartModal').classList.remove('active');
        }
        
        function closeTreasureMartModalOutside(event) {
            if (event.target === event.currentTarget) {
                closeTreasureMartModal();
            }
        }
        
        // ============================================================================
        // MISSING ITEMS REPORT
        // ============================================================================
        
        function showMissingItemsReport() {
            const missingItems = [];
            let totalMissing = 0;
            let totalValue = 0;
            
            for (const [itemId, status] of Object.entries(treasureMartAudit)) {
                if (status === 'missing') {
                    const item = inventory.find(i => String(i.id) === String(itemId));
                    if (item) {
                        const price = calculateChannelPrice(item, 'treasuremarts');
                        missingItems.push({
                            ...item,
                            tmPrice: price
                        });
                        totalMissing += 1;
                        totalValue += price;
                    }
                }
            }
            
            // Sort by shelf, then name
            missingItems.sort((a, b) => {
                const shelfA = a.shelfNumber || 'ZZZ';
                const shelfB = b.shelfNumber || 'ZZZ';
                if (shelfA !== shelfB) return shelfA.localeCompare(shelfB);
                return (a.productName || '').localeCompare(b.productName || '');
            });
            
            const listDiv = document.getElementById('missingItemsList');
            
            if (missingItems.length === 0) {
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #6B7280;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                        <div style="font-size: 16px; font-weight: 600;">No Missing Items</div>
                        <div style="font-size: 14px; margin-top: 5px;">All items have been found or not yet checked.</div>
                    </div>
                `;
            } else {
                listDiv.innerHTML = missingItems.map(item => `
                    <div style="background: #FEF2F2; border: 2px solid #FECACA; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: #DC2626;">${item.productName || 'Unnamed'}</div>
                                <div style="font-size: 12px; color: #6B7280;">SKU: ${item.sku || 'N/A'}</div>
                                <div style="font-size: 12px; color: #6B7280;">Shelf: ${item.shelfNumber || 'N/A'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: #DC2626; font-size: 16px;">$${item.tmPrice.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('missingTotalCount').textContent = totalMissing;
            document.getElementById('missingTotalValue').textContent = '$' + totalValue.toFixed(2);
            
            document.getElementById('missingItemsModal').classList.add('active');
        }
        
        function closeMissingItemsModal() {
            document.getElementById('missingItemsModal').classList.remove('active');
        }
        
        function closeMissingItemsModalOutside(event) {
            if (event.target === event.currentTarget) {
                closeMissingItemsModal();
            }
        }
        
        function copyMissingItemsReport() {
            const missingItems = [];
            let totalValue = 0;
            
            for (const [itemId, status] of Object.entries(treasureMartAudit)) {
                if (status === 'missing') {
                    const item = inventory.find(i => String(i.id) === String(itemId));
                    if (item) {
                        const price = calculateChannelPrice(item, 'treasuremarts');
                        missingItems.push({ ...item, tmPrice: price });
                        totalValue += price;
                    }
                }
            }
            
            missingItems.sort((a, b) => (a.productName || '').localeCompare(b.productName || ''));
            
            const lines = [
                'TREASUREMART MISSING ITEMS REPORT',
                '=' .repeat(40),
                `Date: ${new Date().toLocaleString()}`,
                ''
            ];
            
            missingItems.forEach((item, idx) => {
                lines.push(`${idx + 1}. ${item.productName || 'Unnamed'}`);
                lines.push(`   SKU: ${item.sku || 'N/A'}`);
                lines.push(`   Shelf: ${item.shelfNumber || 'N/A'}`);
                lines.push(`   Value: $${item.tmPrice.toFixed(2)}`);
                lines.push('');
            });
            
            lines.push('=' .repeat(40));
            lines.push(`TOTAL MISSING: ${missingItems.length} items`);
            lines.push(`TOTAL LOST VALUE: $${totalValue.toFixed(2)}`);
            
            navigator.clipboard.writeText(lines.join('\n')).then(() => {
                showToast('Missing items report copied!', 'success');
            }).catch(() => {
                showToast('Failed to copy report', 'error');
            });
        }
        
        // ============================================================================
        // TREASUREMART EXPORT FUNCTIONS
        // ============================================================================
        
        function exportTreasureMartPDF() {
            // Generate printable HTML and open in new window for printing
            const tmItems = inventory.filter(item => {
                const channels = item.channels || {};
                return (channels.treasuremarts || 0) > 0;
            });
            
            tmItems.sort((a, b) => {
                const shelfA = a.shelfNumber || 'ZZZ';
                const shelfB = b.shelfNumber || 'ZZZ';
                if (shelfA !== shelfB) return shelfA.localeCompare(shelfB);
                return (a.productName || '').localeCompare(b.productName || '');
            });
            
            let totalItems = 0;
            let totalValue = 0;
            
            const rows = tmItems.map(item => {
                const channels = item.channels || {};
                const qty = channels.treasuremarts || 0;
                const price = calculateChannelPrice(item, 'treasuremarts');
                const lineTotal = qty * price;
                totalItems += qty;
                totalValue += lineTotal;
                
                const status = treasureMartAudit[item.id] || 'unchecked';
                const statusSymbol = status === 'found' ? '‚úì' : (status === 'missing' ? '‚úó' : '‚óã');
                const rowStyle = status === 'missing' ? 'background: #FEE2E2; color: #DC2626;' : '';
                
                return `
                    <tr style="${rowStyle}">
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 18px;">${statusSymbol}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.shelfNumber || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.productName || 'Unnamed'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.sku || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${qty}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${price.toFixed(2)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${lineTotal.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
            
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>TreasureMart Inventory Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #059669; margin-bottom: 5px; }
                        .date { color: #666; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th { background: #059669; color: white; padding: 10px; text-align: left; }
                        .totals { font-size: 18px; font-weight: bold; }
                        .legend { margin-top: 20px; font-size: 14px; color: #666; }
                        @media print {
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>üêÆ TreasureMart Inventory Report</h1>
                    <div class="date">Generated: ${new Date().toLocaleString()}</div>
                    <button onclick="window.print()" style="padding: 10px 20px; background: #059669; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px;">üñ®Ô∏è Print / Save as PDF</button>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;">‚úì</th>
                                <th>Shelf</th>
                                <th>Product Name</th>
                                <th>SKU</th>
                                <th style="width: 50px;">Qty</th>
                                <th style="width: 80px;">Price</th>
                                <th style="width: 80px;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                    
                    <div class="totals">
                        Total Items: ${totalItems}<br>
                        Total Value: $${totalValue.toFixed(2)}
                    </div>
                    
                    <div class="legend">
                        <strong>Legend:</strong> ‚óã = Unchecked, ‚úì = Found, ‚úó = Missing (highlighted in red)
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            
            logActivity('TM_REPORT_PDF_EXPORTED', { itemCount: tmItems.length });
        }
        
        function exportTreasureMartExcel() {
            // Generate CSV for Excel
            const tmItems = inventory.filter(item => {
                const channels = item.channels || {};
                return (channels.treasuremarts || 0) > 0;
            });
            
            tmItems.sort((a, b) => {
                const shelfA = a.shelfNumber || 'ZZZ';
                const shelfB = b.shelfNumber || 'ZZZ';
                if (shelfA !== shelfB) return shelfA.localeCompare(shelfB);
                return (a.productName || '').localeCompare(b.productName || '');
            });
            
            const headers = ['Status', 'Shelf', 'Product Name', 'SKU', 'Qty', 'Price', 'Total'];
            const rows = [headers.join(',')];
            
            let totalItems = 0;
            let totalValue = 0;
            
            tmItems.forEach(item => {
                const channels = item.channels || {};
                const qty = channels.treasuremarts || 0;
                const price = calculateChannelPrice(item, 'treasuremarts');
                const lineTotal = qty * price;
                totalItems += qty;
                totalValue += lineTotal;
                
                const status = treasureMartAudit[item.id] || 'Unchecked';
                const statusLabel = status === 'found' ? 'Found' : (status === 'missing' ? 'MISSING' : 'Unchecked');
                
                // Escape commas and quotes in CSV
                const escape = (str) => `"${(str || '').replace(/"/g, '""')}"`;
                
                rows.push([
                    statusLabel,
                    escape(item.shelfNumber || 'N/A'),
                    escape(item.productName || 'Unnamed'),
                    escape(item.sku || 'N/A'),
                    qty,
                    price.toFixed(2),
                    lineTotal.toFixed(2)
                ].join(','));
            });
            
            // Add totals row
            rows.push('');
            rows.push(`,,,,${totalItems},Total:,$${totalValue.toFixed(2)}`);
            
            const csv = rows.join('\n');
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TreasureMart_Inventory_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Excel file downloaded!', 'success');
            logActivity('TM_REPORT_EXCEL_EXPORTED', { itemCount: tmItems.length });
        }

        // ============================================================================
        // SYNC WARNING FUNCTIONS
        // ============================================================================
        
        function closeSyncWarning() {
            document.getElementById('syncWarningModal').classList.remove('active');
        }
        
        function closeSyncWarningOutside(event) {
            if (event.target === event.currentTarget) {
                closeSyncWarning();
            }
        }
        
        async function reloadFromFile() {
            if (isConnected) {
                await loadInventoryFromOneDrive();
                closeSyncWarning();
                showToast('Loaded latest version', 'success');
            }
        }

        // ============================================================================
        // TOAST
        // ============================================================================
        
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Load activity log from localStorage
            loadLogFromStorage();
            
            // Load offline queue
            loadOfflineQueue();
            
            // Create token warning banner element
            createTokenWarningBanner();
            
            logActivity('APP_OPENED', { url: window.location.href });
            
            // Check if already authenticated this session
            const authenticated = sessionStorage.getItem('ccd_mobile_auth');
            if (authenticated === 'true') {
                document.getElementById('pinScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.add('active');
                
                logActivity('SESSION_RESUMED', {});
                
                // Initialize MSAL and try to auto-connect
                initializeMsal().then(() => {
                    if (!isConnected) {
                        loadFromStorage();
                    }
                    
                    // Start token health monitoring
                    if (isConnected) {
                        startTokenHealthCheck();
                        
                        // Check if there are queued offline changes to sync
                        if (offlineQueue.length > 0) {
                            setTimeout(syncOfflineQueue, 2000);
                        }
                    }
                });
            }
            
            // Load last sync time
            const lastSync = localStorage.getItem('ccd_mobile_last_sync');
            if (lastSync) {
                lastSyncTime = new Date(lastSync);
                document.getElementById('lastSyncDate').textContent = formatTime(lastSyncTime);
            }
        });
        
        // Warn before leaving with unsaved changes or offline queue
        window.addEventListener('beforeunload', function(e) {
            if (offlineQueue.length > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
